name: Build Project

on:
  push:
    branches: [ "main-ghaction" ]
  pull_request:
    branches: [ "main-ghaction" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Kernel Source
        uses: actions/checkout@v4
        with:
          ref: main-ghaction
          fetch-depth: 1

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git-core gnupg flex bison build-essential zip curl \
            zlib1g-dev libc6-dev-i386 x11proto-core-dev libx11-dev \
            lib32z1-dev libgl1-mesa-dev libxml2-utils xsltproc \
            unzip fontconfig python3 python3-pip lld llvm

      - name: Setup Toolchain
        run: |
          mkdir -p toolchain
          echo "Downloading Clang r416183b..."
          # Clone only the necessary clang version to save time and space
          git clone https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86 --depth=1 -b master toolchain/clang-temp
          
          # Move the specific version to the path expected by build.sh
          mv toolchain/clang-temp/clang-r416183b toolchain/
          rm -rf toolchain/clang-temp
          
          # Verify existence of the tool that caused the previous crash
          if [ -f "toolchain/clang-r416183b/bin/llvm-readelf" ]; then
            echo "Toolchain path verified: toolchain/clang-r416183b/bin/llvm-readelf"
          else
            echo "Error: Toolchain download failed or path is incorrect."
            exit 1
          fi

      - name: Run Build Script
        run: |
          # 1. Fix the 'strict-prototypes' error by downgrading it to a warning
          export CFLAGS="$CFLAGS -Wno-error=strict-prototypes -Wno-strict-prototypes"
          export CPPFLAGS="$CPPFLAGS -Wno-error=strict-prototypes -Wno-strict-prototypes"
          
          # 2. Make script executable
          chmod +x build.sh
          
          # 3. Execute build
          ./build.sh -m all -k y -s y

      - name: Upload Kernel Zips
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Samsung-Exynos9820-Kernels
          path: |
            build/out/**/*.zip
          if-no-files-found: warn
