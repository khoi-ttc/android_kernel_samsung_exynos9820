name: Build Project

on:
  push:
    branches: [ "main-ghaction" ]
  pull_request:
    branches: [ "main-ghaction" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Kernel Source
        uses: actions/checkout@v4
        with:
          ref: main-ghaction
          fetch-depth: 1

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git-core gnupg flex bison build-essential zip curl \
            zlib1g-dev libc6-dev-i386 x11proto-core-dev libx11-dev \
            lib32z1-dev libgl1-mesa-dev libxml2-utils xsltproc \
            unzip fontconfig python3 lld 

      - name: Link Toolchain
        run: |
          # Create the directory structure the script expects
          mkdir -p toolchain
          
          # IF the toolchain is in your repo under a different name, link it:
          # ln -s $(pwd)/my_actual_clang_folder $(pwd)/toolchain/clang-r416183b
          
          # IF you want to use the system's LLVM/Clang (pre-installed on Ubuntu runners):
          # We symlink the system binaries into the folder the script expects
          mkdir -p toolchain/clang-r416183b/bin
          ln -s /usr/bin/llvm-readelf toolchain/clang-r416183b/bin/llvm-readelf
          ln -s /usr/bin/clang toolchain/clang-r416183b/bin/clang
          ln -s /usr/bin/ld.lld toolchain/clang-r416183b/bin/ld.lld
          
          echo "Symlinks created to redirect script to system tools."

      - name: Run Build Script
        run: |
          # Suppress the strict-prototypes error
          export CFLAGS="$CFLAGS -Wno-error=strict-prototypes -Wno-strict-prototypes"
          export CPPFLAGS="$CPPFLAGS -Wno-error=strict-prototypes -Wno-strict-prototypes"
          
          chmod +x build.sh
          ./build.sh -m all -k y -s y

      - name: Upload Kernel Zips
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Samsung-Exynos9820-Kernels
          path: build/out/**/*.zip
